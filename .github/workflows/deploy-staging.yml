name: Deploy to Fly.io Staging

on:
  push:
    branches:
      - 'claude/**'  # Deploy any claude/ feature branch to staging
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest

    # Only run if not on main branch (safety check)
    if: github.ref != 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io Staging
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          # Deploy to staging app
          flyctl deploy \
            --config fly.staging.toml \
            --app link-content-scraper-staging \
            --remote-only

      - name: Set Anthropic API Key Secret
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Set the secret in Fly.io (only if it exists in GitHub secrets)
          if [ ! -z "$ANTHROPIC_API_KEY" ]; then
            echo "Setting ANTHROPIC_API_KEY secret..."
            echo "$ANTHROPIC_API_KEY" | flyctl secrets set ANTHROPIC_API_KEY=- \
              --app link-content-scraper-staging
          else
            echo "‚ö†Ô∏è  Warning: ANTHROPIC_API_KEY not found in GitHub secrets"
            echo "The agent features will not work without this key"
          fi

      - name: Get deployment URL
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "üöÄ Staging deployment complete!"
          echo "üìç URL: https://link-content-scraper-staging.fly.dev"
          echo "ü§ñ Agent UI: https://link-content-scraper-staging.fly.dev/agent"
          echo ""
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: Comment on commit (optional)
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `
            ## üöÄ Staging Deployment Complete!

            **Branch:** \`${context.ref.replace('refs/heads/', '')}\`
            **Commit:** \`${context.sha.substring(0, 7)}\`

            ### üîó URLs:
            - **Main App:** https://link-content-scraper-staging.fly.dev
            - **AI Agent:** https://link-content-scraper-staging.fly.dev/agent
            - **Classic Scraper:** https://link-content-scraper-staging.fly.dev

            ### üß™ Test the new features:
            - Try the prompt-native research workflows
            - Test quick scrape with AI extraction
            - Experiment with batch analysis

            **Note:** Staging environment auto-suspends when idle and wakes on first request (may take a few seconds).
            `;

            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: output
            });
